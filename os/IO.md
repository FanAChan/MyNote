# IO模型

#### 阻塞IO
应用进程向内核发起读取数据请求  
应用进程阻塞，释放cpu，等待内核准备数据  
数据就绪后，内核将数据复制到用户线程，并将结果返回给用户线程  

#### 非阻塞IO
应用进程向内核发起读取数据请求  
请求立即返回，没有数据则用户线程轮询内核数据是否准备就绪  
数据就绪后接受到用户线程请求是将数据复制到用户空间 

#### 多路复用
应用进程调用函数，如select、poll、epoll函数，应用进程阻塞等待事件  
询问线程同时监控多个IO操作，轮询调用函数查看socket的状态  
数据就绪后应用进程将数据将内核空间拷贝到用户空间  
减少创建线程监控IO请求，由内核进行轮询比用户线程进行轮询效率更高
事件响应体很大会导致后续的时间得不到处理，并且会影响新的时间轮询

#### 信号驱动IO
应用进程发出IO请求  
给对应的socket注册一个信号函数 
内核数据准备好之后发送信号通知对应线程
用户线程收到信号后调用IO函数进行实际的读写


#### 异步IO
应用线程发出IO请求
内核建立信号联系
内核将数据准备就绪，并将数据从内核空间复制到用户空间
内核操作完成后通知应用线程


##### Reactor
Reactor：监听和分发时间
Acceptor: 获取连接
Handler：处理业务

通过Select监听事件，监听到事件之后进行分发给Acceptor或者Handler进行处理

###### 单Reactor单进程/线程
全部工作都在同一个进程内完成，所以实现简单，不需要担心进程竞争  
缺点：  
    单进程，无法利用多核CPU的能力  
    handler进行处理时，是无法处理其它连接的时间的，如果业务处理时间长，就会造成响应的延迟
###### 单Reactor多进程/线程
Handler不再负责业务处理，只负责数据的接受和发送，业务处理交给子线程处理，子线程处理完成后将结果
返回给主线程的Handler对象，Handler对象再将结果发送返回
 缺点：
    单Reactor可能成为瞬间高并发的性能瓶颈   
###### 多Reactor多进程/线程
MainReactor通过select监控连接建立时间，收到通知后通过Acceptor对象获取连接
将新的连接分配给子线程
子线程中的SubReactor对象对分配的连接进行监听，并创建Handler用于处理连接的响应事件


###### select/poll/epoll函数调用  
通过一个系统调用函数从内核中获取多个事件。
在获取事件时，先把所有连接（文件描述符）传给内核，再由内核返回产生了事件的连接，
然后在用户态中再处理这些连接对应的请求即可。  

1. select  
将函数描述符集合拷贝到内核中，内核遍历集合的方式将Socket标记上可读或可写事件  
然后再将集合拷贝回用户态。用户态还需再次遍历找到可读或可写的Socket  
使用固定长度的BitsMap表示文件描述符集合  

2. poll  
跟select没有太大的区别，都是使用线性结构存储Socket集合  
使用动态数组，以链表的形式来组织文件描述符  
时间复杂度O(n)  

3. epoll
使用红黑树来跟踪进程所有待检测的文件描述符，增删查的时间复杂度为O(logn)， 
把需要检测的socket加入到内核中的红黑树里， 
不需将整个socket集合传入，只需传入一个待检测的socket，减少内核和用户空间大量的数据拷贝和内存分配  
使用事件驱动机制，内核里维护了一个链表来记录就绪事件，当一个Socket有事件发生时，  
通过回调函数内核会将其加入就绪事件列表中，就绪链表用于保存有事件发生的文件描述符。
epoll_wait仅需要从内核态copy少量的fd到用户态  

4. select/poll/epoll区别
    select/poll时，应用程序每次都将所有的文件描述符从用户态复制到内核态，操作系统内核遍历所有的函数描述符
    标记是否有事件发生，然后在复制回用户态，应用程序再遍历所有的文件描述符处理已发生的网络事件，找出能读或
    能写数据的流进行操作。如果没有IO事件产生，则会在select/poll处阻塞。
    epoll的则使用红黑树的方式，开始时通过epoll_create()闯将一个epoll对象，epoll对象中保存了红黑树的根节点
    和一个双向链表保存发生的事件，当新的套接字连接时，只需要将新的套接字添加到epoll对象中，当调用epoll_wait
    检查是否有事件发生时，只需要检查epoll对象中的双链表是否有元素即可，有则把发生的时间复制到用户态。不需要
    重复传递句柄

4. 事件触发模式：
    - ET模式：边缘触发，第一次满足条件时触发一次
    - LT模式：水平触发，只要满足条件会一直触发
    
> select和poll只支持水平触发模式，epoll都支持。epoll将还有未处理事件的socket放回到epoll对象的链表中。

